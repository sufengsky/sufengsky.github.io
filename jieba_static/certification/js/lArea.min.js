/*
 * lArea城市选择控件
 * 
 * 作者：黄磊
 * 
 * 邮箱：xfhxbb@yeah.net
 * 
 * Copyright 2016
 * 
 * 创建于：2016-2-3
 */
window.lArea=function(){var a=function(){this.gearArea,this.data,this.index=0,this.value=[0,0,0]};return a.prototype={init:function(a){this.params=a,this.trigger=document.querySelector(a.trigger),this.bindEvent(this.type)},getData:function(a){var b=this;if("object"==typeof b.params.data)b.data=b.params.data,a();else{var c=new XMLHttpRequest;c.open("get",b.params.data),c.onload=function(d){if(c.status>=200&&c.status<300||0===c.status){var e=JSON.parse(c.responseText);b.data=e.data,a&&a()}},c.send()}},bindEvent:function(a){function b(a){i.gearArea=document.createElement("div"),i.gearArea.className="gearArea",i.gearArea.innerHTML='<div class="area_ctrl slideInUp"><div class="area_btn_box"><div class="area_btn larea_cancel">取消</div><div class="area_btn larea_finish">确定</div></div><div class="area_roll_mask"><div class="area_roll"><div><div class="gear area_province" data-areatype="area_province"></div><div class="area_grid"></div></div><div><div class="gear area_city" data-areatype="area_city"></div><div class="area_grid"></div></div><div><div class="gear area_county" data-areatype="area_county"></div><div class="area_grid"></div></div></div></div></div>',document.body.appendChild(i.gearArea),c();var b=i.gearArea.querySelector(".larea_cancel");b.addEventListener("touchstart",function(a){i.close(a)});var g=i.gearArea.querySelector(".larea_finish");g.addEventListener("touchstart",function(a){i.finish(a)});var h=i.gearArea.querySelector(".area_province"),j=i.gearArea.querySelector(".area_city"),k=i.gearArea.querySelector(".area_county");h.addEventListener("touchstart",d),j.addEventListener("touchstart",d),k.addEventListener("touchstart",d),h.addEventListener("touchmove",e),j.addEventListener("touchmove",e),k.addEventListener("touchmove",e),h.addEventListener("touchend",f),j.addEventListener("touchend",f),k.addEventListener("touchend",f)}function c(){i.gearArea.querySelector(".area_province").setAttribute("val",i.value[0]),i.gearArea.querySelector(".area_city").setAttribute("val",i.value[1]),i.gearArea.querySelector(".area_county").setAttribute("val",i.value[2]),i.setGearTooth(i.data)}function d(a){a.preventDefault();for(var b=a.target;;){if(b.classList.contains("gear"))break;b=b.parentElement}clearInterval(b["int_"+b.id]),b["old_"+b.id]=a.targetTouches[0].screenY,b["o_t_"+b.id]=(new Date).getTime();var c=b.getAttribute("top");c?b["o_d_"+b.id]=parseFloat(c.replace(/em/g,"")):b["o_d_"+b.id]=0}function e(a){a.preventDefault();for(var b=a.target;;){if(b.classList.contains("gear"))break;b=b.parentElement}b["new_"+b.id]=a.targetTouches[0].screenY,b["n_t_"+b.id]=(new Date).getTime();var c=18*(b["new_"+b.id]-b["old_"+b.id])/370;b["pos_"+b.id]=b["o_d_"+b.id]+c,b.style["-webkit-transform"]="translate3d(0,"+b["pos_"+b.id]+"em,0)",b.setAttribute("top",b["pos_"+b.id]+"em")}function f(a){a.preventDefault();for(var b=a.target;;){if(b.classList.contains("gear"))break;b=b.parentElement}var c=(b["new_"+b.id]-b["old_"+b.id])/(b["n_t_"+b.id]-b["o_t_"+b.id]);Math.abs(c)<=.2?b["spd_"+b.id]=0>c?-.08:.08:Math.abs(c)<=.5?b["spd_"+b.id]=0>c?-.16:.16:b["spd_"+b.id]=c/2,b["pos_"+b.id]||(b["pos_"+b.id]=0),g(b)}function g(a){var b=0,c=!1;clearInterval(a["int_"+a.id]),a["int_"+a.id]=setInterval(function(){var d=a["pos_"+a.id],e=a["spd_"+a.id]*Math.exp(-.03*b);if(d+=e,Math.abs(e)>.1);else{e=.1;var f=2*Math.round(d/2);Math.abs(d-f)<.02?c=!0:d>f?d-=e:d+=e}d>0&&(d=0,c=!0);var g=2*-(a.dataset.len-1);if(g>d&&(d=g,c=!0),c){var i=Math.abs(d)/2;h(a,i),clearInterval(a["int_"+a.id])}a["pos_"+a.id]=d,a.style["-webkit-transform"]="translate3d(0,"+d+"em,0)",a.setAttribute("top",d+"em"),b++},30)}function h(a,b){b=Math.round(b),a.setAttribute("val",b),i.setGearTooth(i.data)}var i=this;i.getData(function(){i.trigger.addEventListener("click",b)})},setGearTooth:function(a){var b=this,c=a||[],d=c.length,e=b.gearArea.querySelectorAll(".gear"),f=e[b.index].getAttribute("val");if(e[b.index].setAttribute("data-len",d),d>0){for(var g=(c[f].id,c[f].child),h="",i=0;d>i;i++)h+="<div class='tooth'  ref='"+c[i].id+"'>"+c[i].name+"</div>";if(e[b.index].innerHTML=h,e[b.index].style["-webkit-transform"]="translate3d(0,"+2*-f+"em,0)",e[b.index].setAttribute("top",2*-f+"em"),b.index++,b.index>2)return void(b.index=0);b.setGearTooth(g)}else e[b.index].innerHTML="<div class='tooth'></div>",b.index=0},finish:function(a){var b=this,c=b.gearArea.querySelector(".area_province"),d=b.gearArea.querySelector(".area_city"),e=b.gearArea.querySelector(".area_county"),f=parseInt(c.getAttribute("val")),g=c.childNodes[f].textContent,h=parseInt(d.getAttribute("val")),i=d.childNodes[h].textContent,j=parseInt(e.getAttribute("val")),k=e.childNodes[j].textContent;b.trigger.value=g+" "+i+" "+k,b.value=[f,h,j],b.close(a)},close:function(a){a.preventDefault();var b=this,c=new CustomEvent("input");b.trigger.dispatchEvent(c),document.body.removeChild(b.gearArea)}},a}();